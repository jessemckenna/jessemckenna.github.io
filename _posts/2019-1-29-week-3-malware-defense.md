---
layout: post
title: Week 3, malware defense
date: 2019-1-29
---

This week's lecture focused on common methods of malware defense, including how malware scanning identifies a piece of software as malware.
<!--more-->

#### Malware defense
The general steps in a malware attack are:
1. **First contact**: distribution of malware to victims via email, web download, watering-hole attack (infiltration of a site frequented by a targeted group of users), physical access, etc.;
2. **Local execution**: typically either tricking the user into running the malware, or exploiting a vulnerability in software present on the machine;
3. **Establish presence**: concealment of malware presence on the system via OS-like naming, timestamp modification, OS modification, etc., followed by persistence long-term; and
4. **Malicious activity**: data collection, OS or browser modification, data transmission to the attacker, etc.

The best approach to malware defense is a layered approach, wherein anti-malware software and best practices are implemented not only on a system itself, but also on its network, data, and physical hardware.

At the *first contact* step, defenses may include trusted download sources (such as an app-store model), user-visible warnings about potentially dangerous sites or emails, and user training. Once first contact has taken place, the risks posed by *local execution* can be mitigated via anti-malware scanning, sandboxed application execution, and secondary authentication for sensitive sites to prevent malware from masquerading as a trusted site. Finally, if execution has taken place and the malware is on a system, network traffic can be monitored for suspicious activity to potentially detect an infection.

#### Malware identification with YARA

Anti-malware software scans for known malware by checking for the *signatures* of known pieces of malware. These are essentially sets of unique rules for identifying malware, such as a particular behavior or unusual string. For example, if I created a piece of 'malware' that modified the hosts file to redirect to this page's URL and created a file called "jesseROCKS", the combination of the URL and string could be used as a signature to identify my malware on someone's system.

A well-known way to write these signatures is using an open language called YARA, which has simple syntax for laying out the rules for identifying a particular piece of malware.

A well-written YARA signature is:
* Short: to save space in an enormous dictionary of signatures;
* Not too specific: to avoid being counteracted by small changes to the malware; and
* Not too general: to limit false positives on clean software and system files

#### Optional lab: YARA signature creation

This week's optional lab work was to inspect a folder of mystery files, choose one that seems like potential malware, describe what it does, and write a YARA signature to identify the malware.

I used FileInsight's *StringsAll* plugin to inspect strings found in the files, and noticed one file (MD5 hash 00670F2B9631D0F97C7CFC6C764DD9D9) that contained some suspicious strings:
* Unfamiliar URLs;
* VBA commands;
* Executable paths in C; and
* The most suspicious string of all, *attrib +r +s +h C:\\qusla.exe >nul*. This is a console command to make a mysterious executable, *qusla.exe*, read-only and hidden.

Having chosen a malware-ish file to inspect, I had the Cuckoo malware analysis software execute the file, then inspected Cuckoo's logs to try and determine what the malware had done.

Of the actions listed in the logs, the following stood out to me as potentially significant:
* Create file C:\\Users\\Admin\\Desktop\\Dx.bat
* Run Dx.bat
* Create file C:\\qusla.exe
* Create file C:\\text.txt
* Repeatedly try to run C:\\msns.exe

After the malware ran, Dx.bat, qusla.exe, and msns.exe were all deleted, but Cuckoo had saved copies of the files in .bin format for inspection. I also noticed an Internet Explorer shortcut had been added to the Desktop.

Dx.bat contained the command *copy bad.exe c:\\qusla.exe >nul*, which copies the malware itself (renamed as *bad* per Cuckoo's naming defaults) followed by the *attrib* command discussed earlier. Finally, Dx.bat contained commands to add qusla.exe to startup, then delete itself.

I was able to copy qusla.exe before it was deleted by running bad.exe with FlyPaper active, which prevents process exit. Inspecting that executable in FileInsight resulted in some more interesting strings:
* hau.exe
* C:\\Program Files\\Internet Explorer\\IEXPLORE.EXE *\[some URLs\]*

The pattern of IEXPLORE.EXE with an unfamiliar URL repeated several times within qusla.exe. When I inspected the Internet Explorer icon on the desktop, I found that one of the URLs had been appended to the Target pointed to by the shortcut. This seems to indicate that the malware's aim is to redirect users to a false landing page and trick them into giving away some information.

Throughout the process, FakeNet showed no network activity, indicating that the malware operates without directly sending home any data from the system; this supports the theory above.

Based on the findings above, I would use the following YARA signature to identify this particular piece of malware:
```
rule qusla
{
	strings:
		$a = "qusla.exe"
		$b = "hau.exe"
		$c = "Dx.bat"
		$d = "msns.exe"
	condition:
		$a and ($b or $c or $d)
}
```

#### Reflection
It was interesting learning about how anti-malware software scans. It seems incredibly daunting to find a unique pattern with which to identify every malware threat. I think I'll be more sympathetic next time I get a false positive from antivirus software.