<!DOCTYPE html>
<html>
<head>
	<title>Jesse McKenna | Week 3, malware defense</title>
	<link rel="stylesheet" href="/assets/css/main.css">
	<meta charset="utf-8">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400|Raleway" rel="stylesheet">
	<script defer src="/assets/js/fontawesome-all.js"></script>
</head>
<body>
<div id="nav-bar">
	<ul>
		<li><a class="nav-link" href="/index.html">HOME</a></li>
		<li><a class="nav-link" href="/resume.html">RESUME</a></li>
		<li><a class="nav-link" href="/skills.html">SKILLS</a></li>
		<li><a class="nav-link" href="/projects.html">PROJECTS</a></li>
		<li><a class="nav-link" href="/blog.html">BLOG</a></li>
	</ul>
</div>
<div id="nav-spacer"></div>

<section class="box">
	<h3>Week 3, malware defense</h3>
	<p class="date">2019-1-29</p>
	<p>This week’s lecture focused on common methods of malware defense, including how malware scanning identifies a piece of software as malware.
<!--more--></p>

<h4 id="malware-defense">Malware defense</h4>
<p>The general steps in a malware attack are:</p>
<ol>
  <li><strong>First contact</strong>: distribution of malware to victims via email, web download, watering-hole attack (infiltration of a site frequented by a targeted group of users), physical access, etc.;</li>
  <li><strong>Local execution</strong>: typically either tricking the user into running the malware, or exploiting a vulnerability in software present on the machine;</li>
  <li><strong>Establish presence</strong>: concealment of malware presence on the system via OS-like naming, timestamp modification, OS modification, etc., followed by persistence long-term; and</li>
  <li><strong>Malicious activity</strong>: data collection, OS or browser modification, data transmission to the attacker, etc.</li>
</ol>

<p>The best approach to malware defense is a layered approach, wherein anti-malware software and best practices are implemented not only on a system itself, but also on its network, data, and physical hardware.</p>

<p>At the <em>first contact</em> step, defenses may include trusted download sources (such as an app-store model), user-visible warnings about potentially dangerous sites or emails, and user training. Once first contact has taken place, the risks posed by <em>local execution</em> can be mitigated via anti-malware scanning, sandboxed application execution, and secondary authentication for sensitive sites to prevent malware from masquerading as a trusted site. Finally, if execution has taken place and the malware is on a system, network traffic can be monitored for suspicious activity to potentially detect an infection.</p>

<h4 id="malware-identification-with-yara">Malware identification with YARA</h4>

<p>Anti-malware software scans for known malware by checking for the <em>signatures</em> of known pieces of malware. These are essentially sets of unique rules for identifying malware, such as a particular behavior or unusual string. For example, if I created a piece of ‘malware’ that modified the hosts file to redirect to this page’s URL and created a file called “jesseROCKS”, the combination of the URL and string could be used as a signature to identify my malware on someone’s system.</p>

<p>A well-known way to write these signatures is using an open language called YARA, which has simple syntax for laying out the rules for identifying a particular piece of malware.</p>

<p>A well-written YARA signature is:</p>
<ul>
  <li>Short: to save space in an enormous dictionary of signatures;</li>
  <li>Not too specific: to avoid being counteracted by small changes to the malware; and</li>
  <li>Not too general: to limit false positives on clean software and system files</li>
</ul>

<h4 id="optional-lab-yara-signature-creation">Optional lab: YARA signature creation</h4>

<p>This week’s optional lab work was to inspect a folder of mystery files, choose one that seems like potential malware, describe what it does, and write a YARA signature to identify the malware.</p>

<p>I used FileInsight’s <em>StringsAll</em> plugin to inspect strings found in the files, and noticed one file (MD5 hash 00670F2B9631D0F97C7CFC6C764DD9D9) that contained some suspicious strings:</p>
<ul>
  <li>Unfamiliar URLs;</li>
  <li>VBA commands;</li>
  <li>Executable paths in C; and</li>
  <li>The most suspicious string of all, <em>attrib +r +s +h C:\qusla.exe &gt;nul</em>. This is a console command to make a mysterious executable, <em>qusla.exe</em>, read-only and hidden.</li>
</ul>

<p>Having chosen a malware-ish file to inspect, I had the Cuckoo malware analysis software execute the file, then inspected Cuckoo’s logs to try and determine what the malware had done.</p>

<p>Of the actions listed in the logs, the following stood out to me as potentially significant:</p>
<ul>
  <li>Create file C:\Users\Admin\Desktop\Dx.bat</li>
  <li>Run Dx.bat</li>
  <li>Create file C:\qusla.exe</li>
  <li>Create file C:\text.txt</li>
  <li>Repeatedly try to run C:\msns.exe</li>
</ul>

<p>After the malware ran, Dx.bat, qusla.exe, and msns.exe were all deleted, but Cuckoo had saved copies of the files in .bin format for inspection. I also noticed an Internet Explorer shortcut had been added to the Desktop.</p>

<p>Dx.bat contained the command <em>copy bad.exe c:\qusla.exe &gt;nul</em>, which copies the malware itself (renamed as <em>bad</em> per Cuckoo’s naming defaults) followed by the <em>attrib</em> command discussed earlier. Finally, Dx.bat contained commands to add qusla.exe to startup, then delete itself.</p>

<p>I was able to copy qusla.exe before it was deleted by running bad.exe with FlyPaper active, which prevents process exit. Inspecting that executable in FileInsight resulted in some more interesting strings:</p>
<ul>
  <li>hau.exe</li>
  <li>C:\Program Files\Internet Explorer\IEXPLORE.EXE <em>[some URLs]</em></li>
</ul>

<p>The pattern of IEXPLORE.EXE with an unfamiliar URL repeated several times within qusla.exe. When I inspected the Internet Explorer icon on the desktop, I found that one of the URLs had been appended to the Target pointed to by the shortcut. This seems to indicate that the malware’s aim is to redirect users to a false landing page and trick them into giving away some information.</p>

<p>Throughout the process, FakeNet showed no network activity, indicating that the malware operates without directly sending home any data from the system; this supports the theory above.</p>

<p>Based on the findings above, I would use the following YARA signature to identify this particular piece of malware:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rule qusla
{
	strings:
		$a = "qusla.exe"
		$b = "hau.exe"
		$c = "Dx.bat"
		$d = "msns.exe"
	condition:
		$a and ($b or $c or $d)
}
</code></pre></div></div>

<h4 id="reflection">Reflection</h4>
<p>It was interesting learning about how anti-malware software scans. It seems incredibly daunting to find a unique pattern with which to identify every malware threat. I think I’ll be more sympathetic next time I get a false positive from antivirus software.</p>

</section>

</body>
<!--Personal-->
<script type="text/javascript" src="/assets/js/scripts.js"></script>
</html>